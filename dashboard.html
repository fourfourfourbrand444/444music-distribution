<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Releases</title>
<link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <div class="navbar">
  <div class="brand">444Music</div>

  <div class="menu">
    <button id="menuBtn">☰</button>
    <ul id="menuList">
      <li onclick="location.href='pricing.html'">Create New Release</li>
      <li onclick="location.href='earnings.html'">Earnings</li>
      <li onclick="location.href='home.html'">Home</li>
      <li onclick="location.href='insights.html'">Insights</li>
      <li onclick="location.href='support.html'">Support/Help</li>
      <li onclick="location.href='playlist.html'">Pitch Playlist </li>
  </div>
</div>
<div class="notice">

 <div class="notice">
  <div class="notice-content">
    <p>
      <strong>NB:</strong> All submitted releases will remain in
      <span class="pending-text">Pending</span> status until payment is made.
      Your music will only be reviewed and distributed after payment is confirmed.
    </p>

    <a class="pay-btn" href="https://wa.me/+233530399523" target="_blank">
      PAY NOW
    </a>
  </div>
</div>


  <a class="pay-btn" href="https://wa.me/+233530399523" target="_blank">
    PAY NOW
  </a>
</div>

<div class="header">
  <h1>My Releases</h1>
</div>
<div class="container" id="submissionsContainer">
</div>

<script>
const menuBtn = document.getElementById("menuBtn");
const menuList = document.getElementById("menuList");

menuBtn.onclick = () => {
  menuList.style.display =
    menuList.style.display === "block" ? "none" : "block";
};
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBzUD7avh7vJfeSMRl2o9F09_qd-pl0dSg",
  authDomain: "usersubmissionsportal.firebaseapp.com",
  projectId: "usersubmissionsportal",
  storageBucket: "usersubmissionsportal.firebasestorage.app",
  messagingSenderId: "734783502459",
  appId: "1:734783502459:web:cfa2cc5de6976003b24ade"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const container = document.getElementById("submissionsContainer");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  /* =========================
     1️⃣ ENSURE USER DOCUMENT
     ========================= */
  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  const name =
    user.displayName ||
    user.email.split("@")[0];

  if (!userSnap.exists()) {
    await setDoc(userRef, {
      name: name,
      email: user.email,
      earnings: 0,
      createdAt: serverTimestamp()
    });
  } else {
    const updates = {};
    const data = userSnap.data();

    if (!data.email) updates.email = user.email;
    if (!data.name) updates.name = name;

    if (Object.keys(updates).length > 0) {
      await updateDoc(userRef, updates);
    }
  }

  /* =========================
     2️⃣ LOAD USER SUBMISSIONS
     ========================= */
  try {
    const q = query(
      collection(db, "submissions"),
      where("userId", "==", user.uid)
    );

    const snapshot = await getDocs(q);

    container.innerHTML = "";

    if (snapshot.empty) {
      container.innerHTML = '<div class="empty">No submissions yet</div>';
      return;
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${data.coverURL || 'default_cover.png'}" alt="Cover Art">
        <div class="card-body">
          <h3>${data.releaseTitle}</h3>
          <p>${data.artistName}</p>
          <span class="badge ${data.status.toLowerCase()}">${data.status}</span>
        </div>
      `;
      container.appendChild(card);
    });

  } catch (err) {
    console.error("Error fetching submissions:", err);
    container.innerHTML = '<div class="empty">Failed to load submissions</div>';
  }
});
</script>

</body>
</html>

